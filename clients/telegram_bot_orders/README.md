# Telegram Bot Orders

Интеграция Telegram-бота для оформления розничных заказов через Regos.

## Возможности
- Каталог номенклатуры с пагинацией, inline‑кнопками и изображениями по `image_url`.
- Корзина на Redis (TTL), добавление/удаление/очистка.
- Создание розничного заказа (`DocOrderDelivery/AddFull`) с источником из настроек.
- Карты покупателя с балансом и QR‑кодом (штрих‑код карты).
- Поиск/создание покупателя по номеру телефона, привязка `field_telegram_id`.

## Настройки (ConnectedIntegrationSetting)
- `BOT_TOKEN` — токен Telegram-бота.
- `PRICE_TYPE_ID` — вид цены.
- `STOCK_ID` — склад.
- `SHOW_ZERO_QUANTITY` — показывать товары с нулевым количеством.
- `SHOW_WITHOUT_IMAGES` — показывать товары без изображений.
- `ORDER_SOURCE_ID` — источник заказа (`from_id`).
- `MIN_ORDER_AMOUNT` — минимальная сумма заказа (0 — без ограничений).
- `WORK_TIME_ENABLED` — ограничение времени работы (true/false).
- `WORK_TIME_START` — начало работы (формат `HH:MM`).
- `WORK_TIME_END` — конец работы (формат `HH:MM`).
- `CUSTOMER_GROUP_ID` — группа для новых покупателей.

## Меню и кнопки
- Главное меню: Каталог, Корзина, Оформить заказ, Карты покупателя.
- Каталог: кнопки «Добавить», «Следующая страница», «Меню».
- Корзина: кнопки «Удалить {id}», «Очистить корзину», «Оформить заказ», «Меню».
- Оформление: запрос номера телефона (кнопка «Поделиться номером»), локации и примечания.
- Команды не используются; управление через inline‑кнопки и системные кнопки Telegram.

## Флоу работы
1) Пользователь открывает бота, получает главное меню и при необходимости делится номером телефона (без «+», только цифры).
2) Бот ищет покупателя по main_phone/search. Если найден — ставит field_telegram_id, если нет — создаёт нового.
3) Каталог (кнопка «Каталог»):
   - запрос Item/GetExt с учётом настроек;
   - карточки с «Добавить», «Следующая страница», изображения по image_url.
4) Корзина (кнопка «Корзина»):
   - хранится в Redis с TTL;
   - управление кнопками: удаление, очистка, оформление.
5) Оформление заказа (кнопка «Оформить заказ»):
   - проверка времени работы и минимальной суммы;
   - запрос локации и примечания;
   - создание DocOrderDelivery/AddFull.
6) Карты покупателя (кнопка «Карты покупателя»):
   - запрос RetailCard/Get по customer_id;
   - отображение баланса и QR-кода.

## Технические детали
- Кэширование данных каталога и карточек в Redis (небольшой TTL).
- Если Redis недоступен, используется память процесса.
- Генерация QR‑кода требует `qrcode` + `pillow` (зависимость опциональна).
