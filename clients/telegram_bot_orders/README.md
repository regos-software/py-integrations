# Telegram Bot Orders

Интеграция Telegram-бота для оформления розничных заказов через Regos.

## Возможности
- Каталог номенклатуры с пагинацией, inline‑кнопками и изображениями по `image_url`.
- Корзина на Redis (TTL), добавление/удаление/очистка.
- Создание розничного заказа (`DocOrderDelivery/AddFull`) с источником из настроек.
- Карты покупателя с балансом и QR‑кодом (штрих‑код карты).
- Поиск/создание покупателя по номеру телефона, привязка `field_telegram_id`.

## Настройки (ConnectedIntegrationSetting)
- `BOT_TOKEN` — токен Telegram-бота.
- `PRICE_TYPE_ID` — вид цены.
- `STOCK_ID` — склад.
- `SHOW_ZERO_QUANTITY` — показывать товары с нулевым количеством.
- `SHOW_WITHOUT_IMAGES` — показывать товары без изображений.
- `ORDER_SOURCE_ID` — источник заказа (`from_id`).
- `MIN_ORDER_AMOUNT` — минимальная сумма заказа (0 — без ограничений).
- `WORK_TIME_ENABLED` — ограничение времени работы (true/false).
- `WORK_TIME_START` — начало работы (формат `HH:MM`).
- `WORK_TIME_END` — конец работы (формат `HH:MM`).
- `CUSTOMER_GROUP_ID` — группа для новых покупателей.

## Команды
- `/start` — приветствие и запрос номера телефона.
- `/help` — список команд.
- `/catalog [поиск]` — каталог с пагинацией.
- `/add <id> [qty]` — добавить товар в корзину.
- `/remove <id>` — удалить товар из корзины.
- `/cart` — показать корзину.
- `/clear` — очистить корзину.
- `/order` — оформить заказ.
- `/card` — показать карты покупателя.

## Флоу работы
1) Пользователь жмет `/start` и делится номером телефона (любая страна, только цифры, без `+`).
2) Бот ищет покупателя по `main_phone`/`search`.  
   - Если найден — записывает `field_telegram_id`.  
   - Если нет — нормализует телефон и создает нового покупателя (`RetailCustomer/Add`).
3) Каталог (`/catalog`):  
   - Запрос `Item/GetExt` с учетом настроек (цены, склад, нулевые остатки, наличие изображений).  
   - Пагинация, inline‑кнопки “Добавить” и “Следующая страница”.  
   - Картинки берутся из `image_url`.
4) Корзина:  
   - Хранится в Redis с TTL.  
   - Добавление/удаление через команды или inline‑кнопки каталога.
5) Оформление заказа (`/order`):  
   - Проверка рабочего времени и минимальной суммы.  
   - Запрос локации пользователя и `description` (примечание к заказу).  
   - Создание `DocOrderDelivery/AddFull` с `from_id`, `stock_id`, `price_type_id`, `amount`, `phone`, `location`, `description`, `external_code`.
6) Карты покупателя (`/card`):  
   - Получение `RetailCard/Get` по `customer_id`.  
   - Вывод баланса и QR‑кода (всегда QR, независимо от типа штрих‑кода).

## Технические детали
- Кэширование данных каталога и карточек в Redis (небольшой TTL).
- Если Redis недоступен, используется память процесса.
- Генерация QR‑кода требует `qrcode` + `pillow` (зависимость опциональна).
